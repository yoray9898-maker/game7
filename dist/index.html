<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>元素戰爭：寒冰禁區 - 策略強化版</title>
    <style>
        /* 保持原有的 CSS 樣式，此處省略以節省篇幅，內容同前次回答 */
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        body { display: flex; flex-direction: column; align-items: center; background-color: #2c3e50; color: white; font-family: 'Microsoft JhengHei', Arial, sans-serif; margin: 0; padding-top: 15px; overflow: hidden; }
        .ui-panel { display: flex; justify-content: space-between; background: #34495e; padding: 15px 25px; width: 610px; border-radius: 4px; margin-bottom: 15px; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .stat-box { text-align: center; flex: 1; }
        .label { font-size: 0.85em; color: #bdc3c7; display: block; margin-bottom: 5px; }
        .stat { font-size: 1.2em; font-weight: bold; color: #f1c40f; }
        #game-container { position: relative; width: 612px; height: 412px; }
        canvas { background-color: #ecf0f1; border: 6px solid #34495e; border-radius: 4px; display: block; touch-action: none; cursor: crosshair; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; border-radius: 4px; }
        .overlay h1 { color: #f1c40f; margin-bottom: 25px; font-size: 2.2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); font-weight: bold; }
        .controls { margin-top: 15px; display: flex; justify-content: space-between; width: 610px; background: #34495e; padding: 10px; border-radius: 4px; gap: 8px; }
        .shop-btn { flex: 1; padding: 12px 0; cursor: pointer; border: 2px solid transparent; border-radius: 4px; color: white; font-weight: bold; font-size: 0.8em; text-align: center; position: relative; transition: all 0.2s; }
        .shop-btn.selected { border: 2px solid #f1c40f !important; transform: translateY(-8px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .nuke-btn { background: #c0392b; border: 2px solid #e74c3c; flex: 1.2; }
        .nuke-badge { position: absolute; top: -10px; right: -10px; background: #f1c40f; color: #2c3e50; width: 26px; height: 26px; border-radius: 50%; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; border: 2px solid #2c3e50; }
        #upgradeMenu { background: #8e44ad; padding: 10px 20px; border-radius: 30px; display: none; gap: 15px; align-items: center; border: 2px solid #f1c40f; margin-top: 15px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="ui-panel">
        <div class="stat-box"><span class="label">金錢</span><span id="money" class="stat">200</span></div>
        <div class="stat-box"><span class="label">生命值</span><span id="health" class="stat">20</span></div>
        <div class="stat-box"><span class="label">波次</span><span id="waveDisplay" class="stat">1</span></div>
        <div class="stat-box"><span class="label">難度</span><span id="diffInfo" class="stat">--</span></div>
    </div>

    <div id="game-container">
        <div id="start-screen" class="overlay">
            <h1>元素戰爭：寒冰禁區</h1>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button style="background:#2ecc71; padding:15px; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="startGame(1.25, '簡單')">簡單模式</button>
                <button style="background:#3498db; padding:15px; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="startGame(1.30, '普通')">普通模式</button>
                <button style="background:#e74c3c; padding:15px; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;" onclick="startGame(1.40, '困難')">困難模式</button>
            </div>
        </div>
        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div id="upgradeMenu">
        <span id="towerInfo" style="font-weight: bold; color:white;"></span>
        <button style="background:#f1c40f; border:none; padding:5px 15px; border-radius:5px; cursor:pointer; font-weight:bold;" onclick="upgradeSelectedTower()">升級 $<span id="upgradeCost"></span></button>
        <button style="background:#EA0000; color:white; border:none; padding:5px 15px; border-radius:5px; cursor:pointer;" onclick="sellSelectedTower()">賣出</button>
        <button style="background:#bdc3c7; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;" onclick="deselectTower()">X</button>
    </div>

    <div class="controls">
        <button class="shop-btn" id="btn-gun" style="background:#2980b9" onclick="selectType('gun')">機槍塔 $50</button>
        <button class="shop-btn" id="btn-ice" style="background:#3498db" onclick="selectType('ice')">寒冰塔 $80</button>
        <button class="shop-btn" id="btn-bomb" style="background:#d35400" onclick="selectType('bomb')">砲擊塔 $120</button>
        <button class="shop-btn" id="btn-summon" style="background:#f1c40f; color:#2c3e50;" onclick="selectType('summon')">召喚塔 $150</button>
        <button class="shop-btn" id="btn-trap" style="background:#7f8c8d" onclick="selectType('trap')">陷阱塔 $150</button>
        <button class="shop-btn nuke-btn" onclick="useNuke()">核彈 $500 <div id="nuke-count" class="nuke-badge">0</div></button>
    </div>

    <script>
        // 核心邏輯整合（僅列出變動較大部分，其餘與前次相同）
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let money = 200, health = 20, currentWave = 1, gameRunning = false;
        let towers = [], enemies = [], bullets = [], minions = [], damageTexts = [], traps = [], shockwaves = [];
        let currentType = null, selectedTower = null, nukeCount = 0, nukeFlash = 0;
        let hpGrowth = 1.3, enemiesToSpawn = 0, spawnTimer = 0, waveInProgress = false;

        const pathPoints = [{x:0,y:1},{x:4,y:1},{x:4,y:4},{x:2,y:4},{x:2,y:6},{x:7,y:6},{x:7,y:2},{x:13,y:2},{x:13,y:5},{x:10,y:5},{x:10,y:7},{x:14,y:7}];
        const mapLayout = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,1,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,1,1,1,0],[0,0,1,1,1,1,1,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];
        const roadTiles = [];
        for(let y=0;y<10;y++) for(let x=0;x<15;x++) if(mapLayout[y][x]===1) roadTiles.push({x,y});

        const towerProps = { 
            gun:[140,25,18,'#2980b9',50], ice:[110,12,35,'#3498db',80], 
            bomb:[170,60,65,'#d35400',120], summon:[150,150,360,'#f1c40f',150], trap:[0,25,300,'#7f8c8d',150] 
        };

        // ... (省略 Enemy 類與基礎函數，邏輯同上)
        class Enemy {
            constructor(wave) {
                this.x = pathPoints[0].x*40; this.y = pathPoints[0].y*40; this.tIdx = 1;
                this.maxHp = 100 * Math.pow(hpGrowth, wave-1); this.hp = this.maxHp; 
                this.baseSpeed = 1.3; this.currentSlow = 0; 
                this.isBoss = wave % 5 === 0;
                this.flash = 0; this.isEnraged = false; this.freezeTimer = 0; this.unstopTimer = 0;
                this.stunTimer = 0; this.hitType = "normal";
            }
            update() {
                if(this.flash > 0) this.flash--;
                if(this.isBoss) {
                    if(this.hp / this.maxHp < 0.3 && !this.isEnraged) {
                        this.isEnraged = true; this.baseSpeed *= 2; this.unstopTimer = 150; 
                        this.currentSlow = 0; this.stunTimer = 0;
                    }
                }
                if(this.unstopTimer > 0) { this.unstopTimer--; this.currentSlow = 0; this.stunTimer = 0; }
                let speed = (this.stunTimer > 0) ? 0 : this.baseSpeed * (1 - this.currentSlow);
                let target = pathPoints[this.tIdx], dx = target.x*40-this.x, dy = target.y*40-this.y, d = Math.sqrt(dx*dx+dy*dy);
                if(d < speed) { this.tIdx++; }
                else if (speed > 0) { this.x += (dx/d)*speed; this.y += (dy/d)*speed; }
                // 緩速衰減改慢，讓持續攻擊更有意義
                this.currentSlow *= 0.995; 
            }
            draw() {
                ctx.fillStyle = "#000"; ctx.fillRect(this.x+5, this.y-8, 30, 5);
                ctx.fillStyle = "#2ecc71"; ctx.fillRect(this.x+5, this.y-8, 30*(this.hp/this.maxHp), 5);
                let bodyColor = this.isBoss ? (this.isEnraged ? "#ff4757" : "#8e44ad") : "#c0392b";
                if(this.flash > 0) bodyColor = (this.hitType === "crit") ? "#ff6b6b" : "white";
                if(this.stunTimer > 0) bodyColor = "#f1c40f";
                ctx.fillStyle = bodyColor;
                ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.isBoss?18:12, 0, Math.PI*2); ctx.fill();
            }
        }

        // 修改後的子彈命中邏輯
        function gameLoop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0,600,400);
            for(let y=0;y<10;y++) for(let x=0;x<15;x++){ ctx.fillStyle=mapLayout[y][x]===1?'#d35400':'#27ae60'; ctx.fillRect(x*40, y*40, 40, 40); }
            
            // ... (省略中間的渲染與陷阱邏輯)

            bullets = bullets.filter(b => {
                let dx = b.target.x+20-b.x, dy = b.target.y+20-b.y, dist = Math.sqrt(dx*dx+dy*dy);
                if(dist < 15) { 
                    let finalDmg = b.dmg;
                    let isCritHit = false;

                    // 機槍塔爆擊
                    if(b.tower.type === 'gun' && b.tower.level >= 3) {
                        if(Math.random() < b.tower.critChance) { finalDmg *= (1 + b.tower.critBonus); isCritHit = true; }
                    }

                    // 寒冰塔：新緩速邏輯
                    if(b.tower.type === 'ice') {
                        if(b.target.unstopTimer <= 0) {
                            let towerSlowAttr = 0.50 + (b.tower.level - 1) * 0.02; // 每級+2%
                            let effectiveSlow = b.target.isBoss ? (towerSlowAttr / 2) : towerSlowAttr; // Boss 效果減半
                            
                            if(b.target.currentSlow === 0) {
                                b.target.currentSlow = effectiveSlow;
                            } else {
                                b.target.currentSlow += (effectiveSlow * 0.02); // 多塔堆疊 2%
                            }
                            // 上限判定
                            let maxLimit = b.target.isBoss ? 0.50 : 0.75;
                            if(b.target.currentSlow > maxLimit) b.target.currentSlow = maxLimit;
                        }
                        if(b.tower.level >= 3 && b.target.currentSlow > 0) finalDmg *= 1.4; // 碎冰加成
                    }

                    // 砲擊塔/召喚塔邏輯同前...
                    b.target.hp -= finalDmg; b.target.flash = 6;
                    b.target.hitType = isCritHit ? "crit" : "normal";
                    addDmgText(b.target.x, b.target.y, Math.floor(finalDmg), isCritHit ? "#ff3f34" : "white", isCritHit);
                    return false; 
                }
                b.x += (dx/dist)*10; b.y += (dy/dist)*10; 
                ctx.fillStyle = b.tower.type === 'ice' ? "#3498db" : (b.tower.type === 'bomb' ? "#d35400" : "#f1c40f");
                ctx.beginPath(); ctx.arc(b.x, b.y, b.tower.type==='bomb'?6:4, 0, Math.PI*2); ctx.fill(); 
                return b.target.hp > 0;
            });

            // ... (其餘循環代碼)
            requestAnimationFrame(gameLoop);
        }

        function startGame(rate, name) {
            hpGrowth = rate; currentDifficulty = name;
            document.getElementById('start-screen').classList.add('hidden');
            gameRunning = true; waveInProgress = true; enemiesToSpawn = 5;
            updateUI(); requestAnimationFrame(gameLoop);
        }
        function updateUI() { document.getElementById('money').innerText = Math.floor(money); document.getElementById('health').innerText = health; document.getElementById('waveDisplay').innerText = currentWave; document.getElementById('nuke-count').innerText = nukeCount; }
        function addDmgText(x, y, text, color, isCrit) { damageTexts.push({ x: x+Math.random()*20, y: y, text, color, life: 50, fontSize: isCrit?22:14 }); }
        function selectType(t) { currentType = t; deselectTower(); }
        function deselectTower() { selectedTower = null; document.getElementById('upgradeMenu').style.display = 'none'; }
        // ... (省略其餘 UI 互動函數)
    </script>
</body>
</html>
