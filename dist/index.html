<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>塔防：元素戰爭 - 三圖整合版</title>
    <style>
        body { display: flex; flex-direction: column; align-items: center; background-color: #2c3e50; color: white; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; overflow: hidden; }
        #game-container { position: relative; margin-top: 10px; }
        canvas { background-color: #ecf0f1; border: 5px solid #34495e; border-radius: 8px; cursor: crosshair; }
        
        /* UI 面板 */
        .ui-panel { margin-top: 10px; padding: 10px 20px; background: #34495e; border-radius: 8px; display: flex; gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 700px; justify-content: space-around; }
        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 85px; }
        .label { font-size: 0.8em; color: #bdc3c7; }
        .stat { font-size: 1.4em; color: #f1c40f; font-weight: bold; }

        /* BOSS 血條 */
        #boss-hp-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            width: 350px; height: 20px; background: rgba(0,0,0,0.6);
            border: 2px solid #fff; border-radius: 10px; display: none; overflow: hidden; z-index: 5;
        }
        #boss-hp-fill { height: 100%; width: 100%; background: #2ecc71; transition: width 0.2s; }
        #boss-hp-text { position: absolute; width: 100%; text-align: center; line-height: 20px; font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px #000; }

        /* 選單與覆蓋層 */
        .overlay {
            position: absolute; top: 0; left: 0; width: 610px; height: 410px;
            background: rgba(44, 62, 80, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; z-index: 10;
        }
        .btn-choice { 
            width: 280px; padding: 12px; margin: 8px; cursor: pointer; border: none; 
            border-radius: 8px; color: white; font-weight: bold; font-size: 1em; transition: 0.2s;
        }
        .btn-choice:hover { transform: scale(1.05); filter: brightness(1.2); }
        
        .easy { background: #27ae60; }
        .normal { background: #2980b9; }
        .hard { background: #c0392b; }
        .map-btn { background: #8e44ad; border: 1px solid #fff; }

        .controls { margin-top: 15px; display: flex; gap: 10px; }
        .shop-btn { padding: 10px 15px; cursor: pointer; border: 3px solid transparent; border-radius: 8px; color: white; font-weight: bold; }
        .shop-btn.selected { border-color: #f1c40f; }
        #upgradeMenu { background: #8e44ad; padding: 10px; border-radius: 8px; display: none; gap: 10px; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>塔防：元素戰爭</h1>

    <div class="ui-panel">
        <div class="stat-box"><span class="label">金錢</span><span id="money" class="stat">200</span></div>
        <div class="stat-box"><span class="label">生命值</span><span id="health" class="stat">20</span></div>
        <div class="stat-box"><span class="label">波次</span><span id="waveDisplay" class="stat">1</span></div>
        <div class="stat-box"><span class="label">情報</span><span id="difficultyInfo" class="stat" style="font-size: 0.8em;">未選擇</span></div>
    </div>

    <div id="game-container">
        <div id="boss-hp-container">
            <div id="boss-hp-fill"></div>
            <div id="boss-hp-text">BOSS HP</div>
        </div>

        <div id="difficulty-screen" class="overlay">
            <h2 style="color: #f1c40f;">選擇難度</h2>
            <button class="btn-choice easy" onclick="pickDifficulty(1.25, '簡單')">簡單 (成長 25%)</button>
            <button class="btn-choice normal" onclick="pickDifficulty(1.30, '普通')">普通 (成長 30%)</button>
            <button class="btn-choice hard" onclick="pickDifficulty(1.40, '困難')">困難 (成長 40%)</button>
        </div>

        <div id="map-screen" class="overlay hidden">
            <h2 style="color: #f1c40f;">選擇地圖佈局</h2>
            <button class="btn-choice map-btn" onclick="pickMap(0)">地圖 A：經典 S 型</button>
            <button class="btn-choice map-btn" onclick="pickMap(1)">地圖 B：大迴旋 U 型</button>
            <button class="btn-choice map-btn" onclick="pickMap(2)">地圖 C：雙十字轉折</button>
        </div>

        <div id="game-over-screen" class="overlay hidden">
            <h2 style="color: #EA0000;">戰地失守</h2>
            <p id="final-stats"></p>
            <button class="btn-choice easy" onclick="location.reload()">重新開始</button>
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div class="controls">
        <div id="shop">
            <button class="shop-btn selected" style="background:#2980b9" onclick="selectType('gun', this)">機槍塔 $50</button>
            <button class="shop-btn" style="background:#3498db" onclick="selectType('ice', this)">寒冰塔 $80</button>
            <button class="shop-btn" style="background:#d35400" onclick="selectType('bomb', this)">砲擊塔 $120</button>
            <button class="shop-btn" style="background:#f1c40f; color:#2c3e50" onclick="selectType('summon', this)">召喚塔 $150</button>
        </div>
        <div id="upgradeMenu">
            <span id="towerInfo"></span>
            <button style="background:#f1c40f; padding:5px 10px;" onclick="upgradeSelectedTower()">升級 ($<span id="upgradeCost"></span>)</button>
            <button style="background:#EA0000; color:white; padding:5px 10px;" onclick="sellSelectedTower()">賣出</button>
            <button style="background:#bdc3c7; padding:5px 10px;" onclick="deselectTower()">取消</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const tileSize = 40;

        const mapConfigs = [
            { // A: S型
                path: [{x:0,y:1},{x:4,y:1},{x:4,y:4},{x:2,y:4},{x:2,y:6},{x:7,y:6},{x:7,y:2},{x:13,y:2},{x:13,y:5},{x:10,y:5},{x:10,y:7},{x:14,y:7}],
                layout: [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,1,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,1,1,1,0],[0,0,1,1,1,1,1,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
            },
            { // B: U型
                path: [{x:0,y:8},{x:13,y:8},{x:13,y:1},{x:2,y:1},{x:2,y:5},{x:11,y:5}],
                layout: [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,1,1,1,1,1,1,1,1,1,1,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
            },
            { // C: 雙十字
                path: [{x:7,y:0},{x:7,y:3},{x:1,y:3},{x:1,y:7},{x:13,y:7},{x:13,y:3},{x:10,y:3},{x:10,y:0}],
                layout: [[0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],[0,1,1,1,1,1,1,1,0,0,1,1,1,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,0,0,0,0,0,0,0,0,0,0,0,1,0],[0,1,1,1,1,1,1,1,1,1,1,1,1,1,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]
            }
        ];

        let money, health, currentWave, enemiesToSpawn, spawnTimer, selectedTower, gameRunning, currentType = 'gun';
        let towers = [], enemies = [], bullets = [], friends = [], particles = [];
        let waveInProgress = false, hpGrowthRate = 1.3, diffName = "", activePath = [], activeLayout = [];

        function pickDifficulty(r, n) { hpGrowthRate = r; diffName = n; document.getElementById('difficulty-screen').classList.add('hidden'); document.getElementById('map-screen').classList.remove('hidden'); }
        function pickMap(idx) { activePath = mapConfigs[idx].path; activeLayout = mapConfigs[idx].layout.map(row => [...row]); document.getElementById('map-screen').classList.add('hidden'); startGame(idx); }

        function startGame(idx) {
            money = 200; health = 20; currentWave = 1; gameRunning = true;
            document.getElementById('difficultyInfo').innerText = `${diffName} / 地圖 ${String.fromCharCode(65+idx)}`;
            startNextWave(); gameLoop();
        }

        function startNextWave() { enemiesToSpawn = (currentWave % 5 === 0) ? 1 : 5 + Math.floor(currentWave * 1.5); spawnTimer = 0; waveInProgress = true; }

        class Enemy {
            constructor(isBoss = false) {
                this.x = activePath[0].x * tileSize; this.y = activePath[0].y * tileSize;
                this.targetIdx = 1; this.isBoss = isBoss;
                const gf = Math.pow(hpGrowthRate, currentWave - 1);
                this.maxHp = Math.floor((isBoss ? 600 : 25) * gf);
                this.hp = this.maxHp; this.speed = isBoss ? 0.6 : (1.3 + Math.random() * 0.7);
                this.slowTimer = 0;
            }
            update() {
                let s = (this.slowTimer > 0) ? this.speed * 0.5 : this.speed;
                if(this.slowTimer > 0) this.slowTimer--;
                
                if(this.isBoss) {
                    const bar = document.getElementById('boss-hp-fill');
                    document.getElementById('boss-hp-container').style.display = 'block';
                    const pct = (this.hp / this.maxHp) * 100;
                    bar.style.width = pct + '%';
                    bar.style.backgroundColor = pct < 30 ? '#ff0000' : '#2ecc71';
                    if(pct < 30) s *= 1.5; // 狂暴
                }

                let t = activePath[this.targetIdx];
                let dx = t.x * tileSize - this.x, dy = t.y * tileSize - this.y;
                let d = Math.sqrt(dx*dx + dy*dy);
                if(d < s) { this.targetIdx++; if(this.targetIdx >= activePath.length) { health -= this.isBoss ? 10 : 1; this.hp = 0; } }
                else { this.x += (dx/d)*s; this.y += (dy/d)*s; }
                if(this.isBoss && this.hp <= 0) document.getElementById('boss-hp-container').style.display = 'none';
            }
            draw() {
                ctx.fillStyle = this.isBoss ? '#8e44ad' : '#c0392b';
                ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.isBoss?18:10, 0, Math.PI*2); ctx.fill();
            }
        }

        class Tower {
            constructor(x,y,type) {
                this.x=x; this.y=y; this.type=type; this.level=1; this.cooldown=0; this.totalSpent=0;
                const base = { gun:[130,12,25,'#2980b9',60,50], ice:[110,5,40,'#3498db',100,80], bomb:[160,50,85,'#d35400',150,120], summon:[0,100,550,'#f1c40f',180,150] };
                [this.range, this.damage, this.cdMax, this.color, this.upCost, this.totalSpent] = base[type];
            }
            getCost() { return Math.floor(this.upCost * Math.pow(1.6, this.level-1)); }
            upgrade() {
                money -= this.getCost(); this.totalSpent += this.getCost(); this.level++;
                const rate = (this.type === 'summon') ? 1.75 : 1.7; // 你要求的成長率
                this.damage = Math.floor(this.damage * rate);
                if(this.type !== 'summon') { this.range += 12; this.cdMax = Math.max(8, Math.floor(this.cdMax*0.85)); }
                else { this.cdMax = Math.max(250, Math.floor(this.cdMax*0.8)); }
            }
            update() {
                if(this.cooldown > 0) this.cooldown--;
                if(this.cooldown <= 0) {
                    if(this.type === 'summon') { friends.push(new Friend(this.damage)); this.cooldown = this.cdMax; }
                    else {
                        const target = enemies.find(e => Math.hypot(e.x-this.x, e.y-this.y) < this.range);
                        if(target) { bullets.push(new Bullet(this.x+20, this.y+20, target, this.damage, this.type)); this.cooldown = this.cdMax; }
                    }
                }
            }
            draw() {
                ctx.fillStyle = this.color; ctx.fillRect(this.x+4, this.y+4, tileSize-8, tileSize-8);
                ctx.fillStyle = "white"; ctx.font = "bold 10px Arial"; ctx.fillText("L"+this.level, this.x+7, this.y+16);
                if(selectedTower === this && this.range > 0) { ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.range, 0, Math.PI*2); ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.stroke(); }
            }
        }

        // --- 輔助邏輯 ---
        class Bullet { constructor(x,y,t,d,tp){this.x=x;this.y=y;this.t=t;this.d=d;this.tp=tp;} update(){let dx=this.t.x+20-this.x, dy=this.t.y+20-this.y, dist=Math.sqrt(dx*dx+dy*dy); if(dist<10){ if(this.tp==='ice') this.t.slowTimer=60; if(this.tp==='bomb') enemies.forEach(e=>{if(Math.hypot(e.x-this.t.x, e.y-this.t.y)<70)e.hp-=this.d;}); else this.t.hp-=this.d; return true; } this.x+=(dx/dist)*12; this.y+=(dy/dist)*12; return false;} draw(){ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(this.x,this.y,3,0,Math.PI*2); ctx.fill();}}
        class Friend { constructor(d){this.x=activePath[activePath.length-1].x*tileSize; this.y=activePath[activePath.length-1].y*tileSize; this.tIdx=activePath.length-2; this.d=d;} update(){let t=activePath[this.tIdx], dx=t.x*tileSize-this.x, dy=t.y*tileSize-this.y, dist=Math.sqrt(dx*dx+dy*dy); if(dist<2){this.tIdx--; if(this.tIdx<0) return true;} else {this.x+=(dx/dist)*2; this.y+=(dy/dist)*2;} for(let e of enemies){if(Math.hypot(this.x-e.x, this.y-e.y)<30){e.hp-=this.d; return true;}} return false;} draw(){ctx.fillStyle="#2ecc71"; ctx.beginPath(); ctx.arc(this.x+20,this.y+20,8,0,Math.PI*2); ctx.fill();}}
        
        function selectType(t, btn) { currentType = t; document.querySelectorAll('.shop-btn').forEach(b=>b.classList.remove('selected')); btn.classList.add('selected'); }
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const gx = Math.floor((e.clientX - rect.left)/tileSize), gy = Math.floor((e.clientY-rect.top)/tileSize);
            const t = towers.find(t=>t.x===gx*tileSize && t.y===gy*tileSize);
            if(t) { selectedTower=t; document.getElementById('shop').style.display='none'; document.getElementById('upgradeMenu').style.display='flex'; document.getElementById('towerInfo').innerText="等級 "+t.level; document.getElementById('upgradeCost').innerText=t.getCost(); }
            else { deselectTower(); const cost={gun:50,ice:80,bomb:120,summon:150}[currentType]; if(activeLayout[gy][gx]===0 && money>=cost){ money-=cost; towers.push(new Tower(gx*tileSize, gy*tileSize, currentType)); activeLayout[gy][gx]=2; } }
        });
        function deselectTower() { selectedTower=null; document.getElementById('shop').style.display='block'; document.getElementById('upgradeMenu').style.display='none'; }
        function upgradeSelectedTower() { if(money>=selectedTower.getCost()) { selectedTower.upgrade(); document.getElementById('towerInfo').innerText="等級 "+selectedTower.level; document.getElementById('upgradeCost').innerText=selectedTower.getCost(); } }
        function sellSelectedTower() { activeLayout[selectedTower.y/tileSize][selectedTower.x/tileSize]=0; money+=Math.floor(selectedTower.totalSpent*0.5); towers=towers.filter(t=>t!==selectedTower); deselectTower(); }

        function gameLoop() {
            if(!gameRunning) return; ctx.clearRect(0,0,600,400);
            for(let y=0;y<10;y++) for(let x=0;x<15;x++) { ctx.fillStyle=activeLayout[y][x]===1?'#d35400':'#27ae60'; ctx.fillRect(x*tileSize,y*tileSize,tileSize,tileSize); }
            if(waveInProgress) { if(enemiesToSpawn>0) { if(++spawnTimer>(currentWave%5===0?100:40)){ enemies.push(new Enemy(currentWave%5===0)); enemiesToSpawn--; spawnTimer=0; } } else if(enemies.length===0){ waveInProgress=false; setTimeout(()=>{if(gameRunning){currentWave++; startNextWave();}}, 2000); } }
            enemies = enemies.filter(e=>{ e.update(); e.draw(); if(e.hp<=0) money+=e.isBoss?200:15; return e.hp>0; });
            towers.forEach(t=>{t.update(); t.draw();});
            bullets = bullets.filter(b=>!b.update()); bullets.forEach(b=>b.draw());
            friends = friends.filter(f=>!f.update()); friends.forEach(f=>f.draw());
            document.getElementById('money').innerText=money; document.getElementById('health').innerText=health; document.getElementById('waveDisplay').innerText=currentWave;
            if(health<=0){ gameRunning=false; document.getElementById('game-over-screen').classList.remove('hidden'); document.getElementById('final-stats').innerText=`最終波次：${currentWave}`; }
            else requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
