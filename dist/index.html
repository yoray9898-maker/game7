<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>塔防：元素戰爭 - 經典完全版</title>
    <style>
        body { display: flex; flex-direction: column; align-items: center; background-color: #2c3e50; color: white; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; overflow: hidden; }
        #game-container { position: relative; margin-top: 10px; }
        canvas { background-color: #ecf0f1; border: 5px solid #34495e; border-radius: 8px; cursor: crosshair; }
        
        .ui-panel { margin-top: 10px; padding: 10px 20px; background: #34495e; border-radius: 8px; display: flex; gap: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); min-width: 600px; justify-content: space-around; }
        .stat-box { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
        .label { font-size: 0.8em; color: #bdc3c7; }
        .stat { font-size: 1.4em; color: #f1c40f; font-weight: bold; }

        .overlay {
            position: absolute; top: 0; left: 0; width: 610px; height: 410px;
            background: rgba(44, 62, 80, 0.95);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 8px; z-index: 10;
        }

        .difficulty-options { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; width: 350px; }
        .btn-choice { font-size: 1em; padding: 12px; color: white; border-radius: 8px; text-align: center; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-choice:hover { transform: scale(1.02); filter: brightness(1.1); }
        
        .easy { background: #27ae60; }
        .normal { background: #2980b9; }
        .hard { background: #c0392b; border: 2px solid #f1c40f; }

        .controls { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
        .shop-btn { padding: 10px 12px; cursor: pointer; border: 3px solid transparent; border-radius: 8px; color: white; font-weight: bold; }
        .shop-btn.selected { border-color: #f1c40f; }
        
        #upgradeMenu { background: #8e44ad; padding: 10px 20px; border-radius: 8px; display: none; gap: 10px; border: 2px solid #f1c40f; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <h1>塔防：元素戰爭</h1>

    <div class="ui-panel">
        <div class="stat-box"><span class="label">金錢</span><span id="money" class="stat">200</span></div>
        <div class="stat-box"><span class="label">生命值</span><span id="health" class="stat">20</span></div>
        <div class="stat-box"><span class="label">目前波次</span><span id="waveDisplay" class="stat">1</span></div>
        <div class="stat-box"><span class="label">難度</span><span id="difficultyDisplay" class="stat" style="font-size: 1em;">未選擇</span></div>
    </div>

    <div id="game-container">
        <div id="difficulty-screen" class="overlay">
            <h2 style="color: #f1c40f;">選擇挑戰難度</h2>
            <div class="difficulty-options">
                <button class="btn-choice easy" onclick="startGame(1.25, '簡單')">簡單：每波敵人血量增加 25%</button>
                <button class="btn-choice normal" onclick="startGame(1.30, '普通')">普通：每波敵人血量增加 30%</button>
                <button class="btn-choice hard" onclick="startGame(1.40, '困難')">困難：每波敵人血量增加 40%</button>
            </div>
        </div>

        <div id="game-over-screen" class="overlay hidden">
            <h2 style="color: #EA0000;">戰地失守</h2>
            <button class="btn-choice easy" onclick="location.reload()">重新開始</button>
        </div>

        <canvas id="gameCanvas" width="600" height="400"></canvas>
    </div>

    <div class="controls">
        <div id="shop">
            <button class="shop-btn selected" style="background:#2980b9" id="btn-gun" onclick="selectType('gun')">機槍塔 $50</button>
            <button class="shop-btn" style="background:#3498db" id="btn-ice" onclick="selectType('ice')">寒冰塔 $80</button>
            <button class="shop-btn" style="background:#d35400" id="btn-bomb" onclick="selectType('bomb')">砲擊塔 $120</button>
            <button class="shop-btn" style="background:#f1c40f; color: #2c3e50;" id="btn-summon" onclick="selectType('summon')">召喚塔 $150</button>
        </div>
        <div id="upgradeMenu">
            <span id="towerInfo" style="font-weight: bold;"></span>
            <button style="background:#f1c40f; color:#2c3e50; padding:8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="upgradeSelectedTower()">升級 ($<span id="upgradeCost"></span>)</button>
            <button style="background:#EA0000; color:white; padding:8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="sellSelectedTower()">賣出</button>
            <button style="background:#bdc3c7; color:#2c3e50; padding:8px 15px; border:none; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="deselectTower()">取消</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const tileSize = 40;

        const path = [{x:0,y:1},{x:4,y:1},{x:4,y:4},{x:2,y:4},{x:2,y:6},{x:7,y:6},{x:7,y:2},{x:13,y:2},{x:13,y:5},{x:10,y:5},{x:10,y:7},{x:14,y:7}];
        const mapLayout = [[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,1,0,0,1,1,1,1,1,1,1,0],[0,0,0,0,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,1,1,0,0,1,0,0,0,0,0,1,0],[0,0,1,0,0,0,0,1,0,0,1,1,1,1,0],[0,0,1,1,1,1,1,1,0,0,1,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]];

        let money = 200, health = 20, currentWave = 1;
        let towers = [], enemies = [], bullets = [], friends = [];
        let gameRunning = false, waveInProgress = false, hpGrowthRate = 1.3;
        let currentType = 'gun', selectedTower = null;

        function startGame(rate, name) {
            hpGrowthRate = rate;
            document.getElementById('difficultyDisplay').innerText = name;
            document.getElementById('difficulty-screen').classList.add('hidden');
            gameRunning = true;
            startNextWave();
            gameLoop();
        }

        function startNextWave() {
            let count = (currentWave % 5 === 0) ? 1 : 5 + Math.floor(currentWave * 1.5);
            let spawned = 0;
            waveInProgress = true;
            let interval = setInterval(() => {
                if (spawned < count) {
                    enemies.push(new Enemy(currentWave % 5 === 0));
                    spawned++;
                } else {
                    clearInterval(interval);
                }
            }, (currentWave % 5 === 0) ? 1000 : 500);
        }

        class Enemy {
            constructor(isBoss) {
                this.x = path[0].x * tileSize; this.y = path[0].y * tileSize;
                this.targetIdx = 1; this.isBoss = isBoss;
                this.maxHp = Math.floor((isBoss ? 600 : 25) * Math.pow(hpGrowthRate, currentWave - 1));
                this.hp = this.maxHp;
                this.speed = isBoss ? 0.6 : (1.3 + Math.random() * 0.7);
                this.slowTimer = 0;
            }
            update() {
                let s = this.slowTimer > 0 ? this.speed * 0.5 : this.speed;
                if(this.slowTimer > 0) this.slowTimer--;
                let t = path[this.targetIdx];
                let dx = t.x * tileSize - this.x, dy = t.y * tileSize - this.y;
                let d = Math.sqrt(dx*dx + dy*dy);
                if(d < s) {
                    this.targetIdx++;
                    if(this.targetIdx >= path.length) { health -= this.isBoss ? 10 : 1; this.hp = 0; }
                } else { this.x += (dx/d)*s; this.y += (dy/d)*s; }
            }
            draw() {
                // 敵人圓球
                ctx.fillStyle = this.isBoss ? '#8e44ad' : '#c0392b';
                ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.isBoss?18:10, 0, Math.PI*2); ctx.fill();
                // 敵人血量條 (綠色)
                ctx.fillStyle = 'black'; ctx.fillRect(this.x+5, this.y, 30, 4);
                ctx.fillStyle = '#2ecc71'; ctx.fillRect(this.x+5, this.y, (this.hp/this.maxHp)*30, 4);
            }
        }

        class Tower {
            constructor(x, y, type) {
                this.x = x; this.y = y; this.type = type; this.level = 1; this.cooldown = 0; this.totalSpent = 0;
                const base = { gun:[130,12,25,'#2980b9',60,50], ice:[110,5,40,'#3498db',100,80], bomb:[160,50,85,'#d35400',150,120], summon:[0,100,550,'#f1c40f',180,150] };
                [this.range, this.damage, this.cdMax, this.color, this.upCost, this.totalSpent] = base[type];
            }
            getCost() { return Math.floor(this.upCost * Math.pow(1.6, this.level - 1)); }
            upgrade() {
                let cost = this.getCost(); money -= cost; this.totalSpent += cost; this.level++;
                const rate = (this.type === 'summon') ? 1.75 : 1.7;
                this.damage = Math.floor(this.damage * rate);
                if(this.type !== 'summon') { this.range += 12; this.cdMax = Math.max(8, Math.floor(this.cdMax * 0.85)); }
                else { this.cdMax = Math.max(250, Math.floor(this.cdMax * 0.8)); }
            }
            update() {
                if(this.cooldown > 0) this.cooldown--;
                if(this.cooldown <= 0) {
                    if(this.type === 'summon') { friends.push(new Friend(this.damage)); this.cooldown = this.cdMax; }
                    else {
                        let target = enemies.find(e => Math.hypot(e.x+20 - (this.x+20), e.y+20 - (this.y+20)) < this.range);
                        if(target) { bullets.push(new Bullet(this.x+20, this.y+20, target, this.damage, this.type)); this.cooldown = this.cdMax; }
                    }
                }
            }
            draw() {
                // 繪製塔身
                ctx.fillStyle = this.color; ctx.fillRect(this.x+4, this.y+4, tileSize-8, tileSize-8);
                // 繪製等級 Lv. (白色字體)
                ctx.fillStyle = "white"; ctx.font = "bold 10px Arial"; ctx.fillText("Lv."+this.level, this.x+6, this.y+16);
                // 範圍圈
                if(selectedTower === this && this.range > 0) {
                    ctx.beginPath(); ctx.arc(this.x+20, this.y+20, this.range, 0, Math.PI*2);
                    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1; ctx.stroke();
                }
            }
        }

        class Bullet { constructor(x,y,t,d,tp){this.x=x;this.y=y;this.t=t;this.d=d;this.tp=tp;} update(){let dx=this.t.x+20-this.x, dy=this.t.y+20-this.y, dist=Math.sqrt(dx*dx+dy*dy); if(dist<10){ if(this.tp==='ice') this.t.slowTimer=60; if(this.tp==='bomb') enemies.forEach(e=>{if(Math.hypot(e.x-this.t.x, e.y-this.t.y)<70)e.hp-=this.d;}); else this.t.hp-=this.d; return true; } this.x+=(dx/dist)*12; this.y+=(dy/dist)*12; return false;} draw(){ctx.fillStyle="#f1c40f"; ctx.beginPath(); ctx.arc(this.x,this.y,3,0,Math.PI*2); ctx.fill();}}
        class Friend { constructor(d){this.x=path[path.length-1].x*tileSize; this.y=path[path.length-1].y*tileSize; this.tIdx=path.length-2; this.d=d;} update(){let t=path[this.tIdx], dx=t.x*tileSize-this.x, dy=t.y*tileSize-this.y, d=Math.sqrt(dx*dx+dy*dy); if(d<2){this.tIdx--; if(this.tIdx<0) return true;} else {this.x+=(dx/d)*2; this.y+=(dy/d)*2;} for(let e of enemies){if(Math.hypot(this.x-e.x, this.y-e.y)<30){e.hp-=this.d; return true;}} return false;} draw(){ctx.fillStyle="#2ecc71"; ctx.beginPath(); ctx.arc(this.x+20,this.y+20,8,0,Math.PI*2); ctx.fill();}}

        function selectType(t) { currentType = t; document.querySelectorAll('.shop-btn').forEach(b => b.classList.remove('selected')); document.getElementById('btn-'+t).classList.add('selected'); }
        
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const gx = Math.floor((e.clientX - rect.left)/tileSize), gy = Math.floor((e.clientY-rect.top)/tileSize);
            const t = towers.find(t=>t.x===gx*tileSize && t.y===gy*tileSize);
            if(t) {
                selectedTower = t;
                document.getElementById('shop').style.display = 'none';
                document.getElementById('upgradeMenu').style.display = 'flex';
                document.getElementById('towerInfo').innerText = "Lv." + t.level + " 塔位";
                document.getElementById('upgradeCost').innerText = t.getCost();
            } else {
                deselectTower();
                const cost = {gun:50, ice:80, bomb:120, summon:150}[currentType];
                if(gx>=0 && gx<15 && gy>=0 && gy<10 && mapLayout[gy][gx] === 0 && money >= cost) {
                    money -= cost;
                    towers.push(new Tower(gx*tileSize, gy*tileSize, currentType));
                    mapLayout[gy][gx] = 2;
                }
            }
        });

        function deselectTower() { selectedTower = null; document.getElementById('shop').style.display = 'block'; document.getElementById('upgradeMenu').style.display = 'none'; }
        function upgradeSelectedTower() { if(money >= selectedTower.getCost()) { selectedTower.upgrade(); deselectTower(); } }
        function sellSelectedTower() { mapLayout[selectedTower.y/tileSize][selectedTower.x/tileSize] = 0; money += Math.floor(selectedTower.totalSpent * 0.5); towers = towers.filter(t => t !== selectedTower); deselectTower(); }

        function gameLoop() {
            if(!gameRunning) return;
            ctx.clearRect(0,0,600,400);
            for(let y=0; y<10; y++) for(let x=0; x<15; x++) { ctx.fillStyle = mapLayout[y][x] === 1 ? '#d35400' : '#27ae60'; ctx.fillRect(x*tileSize, y*tileSize, tileSize, tileSize); }
            
            enemies = enemies.filter(e => {
                e.update(); e.draw();
                if(e.hp <= 0) money += e.isBoss ? 150 : 15;
                return e.hp > 0;
            });
            
            if(waveInProgress && enemies.length === 0) {
                waveInProgress = false;
                setTimeout(() => { if(gameRunning) { currentWave++; startNextWave(); } }, 2000);
            }

            towers.forEach(t => { t.update(); t.draw(); });
            bullets = bullets.filter(b => !b.update()); bullets.forEach(b => b.draw());
            friends = friends.filter(f => !f.update()); friends.forEach(f => f.draw());

            document.getElementById('money').innerText = money;
            document.getElementById('health').innerText = health;
            document.getElementById('waveDisplay').innerText = currentWave;

            if(health <= 0) { gameRunning = false; document.getElementById('game-over-screen').classList.remove('hidden'); }
            else requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
